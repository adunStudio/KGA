# AI와 패턴 설계

### AI의 활용

- 실생활에서 실제로 일어나는 행동의 구현
- 유저의 감정 몰입
- 전형적이지 않은, 항상 새로운 상황의 구현

### 기본적인 AI / 패턴 설계 요소

- AI가 자신의 기준으로 상황을 **분석**해야 함
- 분석에 따라 **반응**해야 함
- 필요하다면, 분석에 따라 이후 상황을 **예측**해야 함

### AI와 패턴 설정의 고려 사항

- 해당 몬스터의 주요 설계 목적
- 공격 전환
- 도망 설정
- 공격 타겟 결정
- 몬스터의 상태 및 행동 리스트
- 몬스터의 조합

#### 공격 전환

몬스터의 AI 타입에 따라 다음 상황에 IDLE → 공격 상태로 전환

- 캐릭터의 공격을 받았을 경우
- 시야 안에 캐릭터가 포착되었을 경우
- 이벤트 등에 의한 강제 전투

반대로 다음 상황에 공격 → IDLE 상태로 전환

- 시야에서 캐릭터가 사라짐
- 공격 타겟의 사망
- 캐릭터가 몬스터의 순찰 범위 바깥으로 이동
- 이벤트 등에 의한 강제 전투 종료

#### 도망 체크

공격 행동과 도망 행동을 결정

도망 체크 예시

- 기본 용기 수치 = 100 * (HP/MaxHP)
- 몬스터 테이블(혹은 AI 테이블)에 **도망 수치** 지정
- 시야 안에 동료가 있을 때 추가되는 보너스 용기 수치를 테이블에 지정

| 동료1 ID | 동료 1 추가 용기 | 동료2 ID | 동료2 추가 용기 | 동료3 ID | 동료3 추가 용기 |
| -------- | ---------------- | -------- | --------------- | -------- | --------------- |
| 10015    | 5                | 10016    | 10              | 10018    | 15              |

- 몬스터의 용기가 도망 수치보다 높을 경우 공격, 이하일 경우 도망을 선택

#### 공격 타겟 설정

적대도는 다음과 같은 경우에 상승

- 일반 공격을 당함 (데미지를 적대도로 환산)
- 스킬 공격을 당함 (데미지, 적대 보너스를 적대도로 환산)
- 적대도 체크 테이블에 있는 대상을 치료, 버프
- 디버프를 당함 (적대 보너스를 적대도로 환산)
- 무조건 어그로를 스킬을 당함
- 적대도 테이블은 수시 체크+체크 대상이 많기 때문에 필요 없는 적대 체크 대상을 주기적으로 삭제해야 함

적대도를 체크하는 테이블로 가장 적대적인 상대를 체크

체크 타겟 ID

- 몬스터 주변의 모든 적대적인 객체(캐릭터, 소환수, NPC, 공격 건물 등)를 체크하는 ID
- 해당 ID는 서버 프로그래머의 설계 규약에 맞추어 설정

| 타겟1 ID | 타겟1 적대도 | 타겟2 ID | 타겟2 적대도 | 타겟3 ID | 타겟3 적대도 |
| -------- | ------------ | -------- | ------------ | -------- | ------------ |
| 103      | 10           | 104      | 20           | 105      | 30           |

- 공격 타이밍이 되면 적대도가 가장 높은 타겟을 공격

### FSM(Finite State Machine)과 BT(Behavior Tree)

#### FSM(유한 상태 머신)

- 일반적으로 많이 사용하는 모델로서 각 상태들을 조건의 흐름에 따라 정의하여 AI를 구성하는 방식
- 간단한 상태 변화를 가진 AI를 구현하기에는 좋으나 변화하는 상태가 많아질 수록 관리하기가 힘들어 상태 변화의 확장이 제한됨

#### HFSM(Hierarchical FSM: 계층적 유한 상태 머신)

- 일반적인 FSM의 모델을 확장시킨 모델로서 전체 흐름을 그룹화하고 그룹을 세부 FSM으로 보완하여 다양한 상태들을 처리
- 세부 FSM을 모듈화 하여 조합하면 다양한 AI 유형을 만들 수 있음

#### BT(행동 트리)

- 상태를 계층적으로 나누어 정의하는 방식으로 전체 상태를 파악하고 모듈화 하는데 편리함
- 트리 탐색 구조를 이용해 우선 순위를 정함
- FSM: 상태를 정의하고 이벤트에 따라 사앹가 바뀌는 것을 구조화
- BT: AI가 달성할 목표를 정의하고 서브 태스크로 나누어 구조화
  - Selector: 1개라도 참이면 실행
  - Sequence: 모두 참이면 실행